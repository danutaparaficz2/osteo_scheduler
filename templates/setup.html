{% extends "base.html" %}

{% block title %}Setup - Osteo Scheduler{% endblock %}

{% block content %}
<div class="card">
    <h2>Data Setup</h2>
    <p>Configure your scheduling data: lecturers, rooms, subjects, and time structure.</p>
</div>

<!-- Lecturers Section -->
<div class="card">
    <h2>Lecturers</h2>
    <div id="lecturersContainer"></div>
    <button class="btn btn-success" onclick="showAddLecturerForm()">Add Lecturer</button>
</div>

<!-- Rooms Section -->
<div class="card">
    <h2>Rooms</h2>
    <div id="roomsContainer"></div>
    <button class="btn btn-success" onclick="showAddRoomForm()">Add Room</button>
</div>

<!-- Subjects Section -->
<div class="card">
    <h2>Subjects</h2>
    <div id="subjectsContainer"></div>
    <button class="btn btn-success" onclick="showAddSubjectForm()">Add Subject</button>
</div>

<!-- Modal for adding items -->
<div id="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto;">
    <div style="background: white; margin: 5% auto; padding: 2rem; width: 80%; max-width: 600px; border-radius: 8px;">
        <span style="float: right; font-size: 2rem; cursor: pointer;" onclick="closeModal()">&times;</span>
        <div id="modalContent"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load data on page load
    window.addEventListener('DOMContentLoaded', () => {
        loadLecturers();
        loadRooms();
        loadSubjects();
    });
    
    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }
    
    function showModal(content) {
        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('modal').style.display = 'block';
    }
    
    // Lecturers
    async function loadLecturers() {
        try {
            const lecturers = await fetchJSON('/api/lecturers');
            const container = document.getElementById('lecturersContainer');
            
            if (lecturers.length === 0) {
                container.innerHTML = '<p>No lecturers added yet.</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Max Hours/Week</th><th>Available Slots</th><th>Actions</th></tr></thead><tbody>';
            lecturers.forEach(l => {
                html += `<tr>
                    <td>${l.id}</td>
                    <td>${l.name}</td>
                    <td>${l.max_hours_per_week || 'N/A'}</td>
                    <td>${l.available_slots.length} slots</td>
                    <td><button class="btn btn-danger" onclick="deleteLecturer('${l.id}')">Delete</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Failed to load lecturers:', error);
        }
    }
    
    function showAddLecturerForm() {
        const form = `
            <h3>Add Lecturer</h3>
            <form onsubmit="addLecturer(event)">
                <div class="form-group">
                    <label>ID:</label>
                    <input type="text" name="id" required>
                </div>
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Max Hours Per Week:</label>
                    <input type="number" name="max_hours_per_week">
                </div>
                <p><em>Note: For simplicity, this form creates lecturers with standard weekday availability (Mon-Fri, 8 AM - 6 PM).</em></p>
                <button type="submit" class="btn btn-success">Add</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </form>
        `;
        showModal(form);
    }
    
    async function addLecturer(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        // Create standard availability slots
        const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY'];
        const available_slots = [];
        days.forEach(day => {
            for (let hour = 8; hour < 18; hour++) {
                available_slots.push({
                    day: day,
                    start_hour: hour,
                    start_minute: 0,
                    duration_minutes: 60
                });
            }
        });
        
        const lecturer = {
            id: formData.get('id'),
            name: formData.get('name'),
            max_hours_per_week: formData.get('max_hours_per_week') ? parseInt(formData.get('max_hours_per_week')) : null,
            available_slots: available_slots
        };
        
        try {
            await fetchJSON('/api/lecturers', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(lecturer)
            });
            showAlert('Lecturer added successfully', 'success');
            closeModal();
            loadLecturers();
        } catch (error) {
            console.error('Failed to add lecturer:', error);
        }
    }
    
    async function deleteLecturer(id) {
        if (!confirm('Are you sure you want to delete this lecturer?')) return;
        
        try {
            await fetchJSON('/api/lecturers', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id})
            });
            showAlert('Lecturer deleted', 'success');
            loadLecturers();
        } catch (error) {
            console.error('Failed to delete lecturer:', error);
        }
    }
    
    // Rooms
    async function loadRooms() {
        try {
            const rooms = await fetchJSON('/api/rooms');
            const container = document.getElementById('roomsContainer');
            
            if (rooms.length === 0) {
                container.innerHTML = '<p>No rooms added yet.</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Capacity</th><th>Features</th><th>Actions</th></tr></thead><tbody>';
            rooms.forEach(r => {
                html += `<tr>
                    <td>${r.id}</td>
                    <td>${r.name}</td>
                    <td>${r.capacity}</td>
                    <td>${r.features.join(', ') || 'None'}</td>
                    <td><button class="btn btn-danger" onclick="deleteRoom('${r.id}')">Delete</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Failed to load rooms:', error);
        }
    }
    
    function showAddRoomForm() {
        const form = `
            <h3>Add Room</h3>
            <form onsubmit="addRoom(event)">
                <div class="form-group">
                    <label>ID:</label>
                    <input type="text" name="id" required>
                </div>
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Capacity:</label>
                    <input type="number" name="capacity" required>
                </div>
                <div class="form-group">
                    <label>Features (comma-separated):</label>
                    <input type="text" name="features" placeholder="projector, whiteboard, lab_equipment">
                </div>
                <button type="submit" class="btn btn-success">Add</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </form>
        `;
        showModal(form);
    }
    
    async function addRoom(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        const features = formData.get('features') 
            ? formData.get('features').split(',').map(f => f.trim()).filter(f => f)
            : [];
        
        const room = {
            id: formData.get('id'),
            name: formData.get('name'),
            capacity: parseInt(formData.get('capacity')),
            features: features
        };
        
        try {
            await fetchJSON('/api/rooms', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(room)
            });
            showAlert('Room added successfully', 'success');
            closeModal();
            loadRooms();
        } catch (error) {
            console.error('Failed to add room:', error);
        }
    }
    
    async function deleteRoom(id) {
        if (!confirm('Are you sure you want to delete this room?')) return;
        
        try {
            await fetchJSON('/api/rooms', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id})
            });
            showAlert('Room deleted', 'success');
            loadRooms();
        } catch (error) {
            console.error('Failed to delete room:', error);
        }
    }
    
    // Subjects
    async function loadSubjects() {
        try {
            const subjects = await fetchJSON('/api/subjects');
            const container = document.getElementById('subjectsContainer');
            
            if (subjects.length === 0) {
                container.innerHTML = '<p>No subjects added yet.</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>ID</th><th>Name</th><th>Duration</th><th>Min Capacity</th><th>Lecturers</th><th>Sessions/Week</th><th>Actions</th></tr></thead><tbody>';
            subjects.forEach(s => {
                html += `<tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.duration_minutes} min</td>
                    <td>${s.min_capacity}</td>
                    <td>${s.required_lecturers.length}</td>
                    <td>${s.sessions_per_week}</td>
                    <td><button class="btn btn-danger" onclick="deleteSubject('${s.id}')">Delete</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        } catch (error) {
            console.error('Failed to load subjects:', error);
        }
    }
    
    async function showAddSubjectForm() {
        // Load lecturers for dropdown
        const lecturers = await fetchJSON('/api/lecturers');
        
        let lecturerOptions = '';
        lecturers.forEach(l => {
            lecturerOptions += `<option value="${l.id}">${l.name}</option>`;
        });
        
        const form = `
            <h3>Add Subject</h3>
            <form onsubmit="addSubject(event)">
                <div class="form-group">
                    <label>ID:</label>
                    <input type="text" name="id" required>
                </div>
                <div class="form-group">
                    <label>Name:</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Duration (minutes):</label>
                    <input type="number" name="duration_minutes" value="60" required>
                </div>
                <div class="form-group">
                    <label>Minimum Capacity:</label>
                    <input type="number" name="min_capacity" required>
                </div>
                <div class="form-group">
                    <label>Required Lecturers:</label>
                    <select name="required_lecturers" multiple size="5">
                        ${lecturerOptions}
                    </select>
                    <small>Hold Ctrl/Cmd to select multiple</small>
                </div>
                <div class="form-group">
                    <label>Sessions Per Week:</label>
                    <input type="number" name="sessions_per_week" value="1" required>
                </div>
                <div class="form-group">
                    <label>Required Features (comma-separated):</label>
                    <input type="text" name="required_features" placeholder="projector, lab_equipment">
                </div>
                <button type="submit" class="btn btn-success">Add</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </form>
        `;
        showModal(form);
    }
    
    async function addSubject(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        
        const features = formData.get('required_features')
            ? formData.get('required_features').split(',').map(f => f.trim()).filter(f => f)
            : [];
        
        const required_lecturers = Array.from(
            event.target.elements.required_lecturers.selectedOptions
        ).map(option => option.value);
        
        const subject = {
            id: formData.get('id'),
            name: formData.get('name'),
            duration_minutes: parseInt(formData.get('duration_minutes')),
            min_capacity: parseInt(formData.get('min_capacity')),
            required_lecturers: required_lecturers,
            required_features: features,
            sessions_per_week: parseInt(formData.get('sessions_per_week'))
        };
        
        try {
            await fetchJSON('/api/subjects', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(subject)
            });
            showAlert('Subject added successfully', 'success');
            closeModal();
            loadSubjects();
        } catch (error) {
            console.error('Failed to add subject:', error);
        }
    }
    
    async function deleteSubject(id) {
        if (!confirm('Are you sure you want to delete this subject?')) return;
        
        try {
            await fetchJSON('/api/subjects', {
                method: 'DELETE',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: id})
            });
            showAlert('Subject deleted', 'success');
            loadSubjects();
        } catch (error) {
            console.error('Failed to delete subject:', error);
        }
    }
</script>
{% endblock %}
